/*
 * RailsAdmin filtering select @VERSION
 *
 * Based on the combobox example from jQuery UI documentation
 * http://jqueryui.com/demos/autocomplete/#combobox
 *
 * License
 *
 * http://www.railsadmin.org
 *
 * Depends:
 *   jquery.ui.core.js
 *   jquery.ui.widget.js
 *   jquery.ui.autocomplete.js
 */
(function(e){e.widget("ra.filteringSelect",{options:{createQuery:function(e){return{query:e}},minLength:0,searchDelay:200,remote_source:null,source:null,xhr:!1},_create:function(){var t=this,n=this.element.hide(),r=n.children(":selected"),i=r.val()?r.text():"";this.options.xhr?this.options.source=this.options.remote_source:this.options.source=n.children("option").map(function(){return{label:e(this).text(),value:this.value}}).toArray();var s=e('<div class="input-append filtering-select" style="float:left"></div>'),o=this.input=e('<input type="text">').val(i).addClass("ra-filtering-select-input").attr("style",n.attr("style")).show().autocomplete({delay:this.options.searchDelay,minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(r,i){var s=e('<option value="'+i.item.id+'" selected="selected">'+i.item.value+"</option>");n.html(s),n.trigger("change",i.item.id),t._trigger("selected",r,{item:s}),e(t.element.parents(".controls")[0]).find(".update").removeClass("disabled")},change:function(r,i){if(!i.item){var s=new RegExp("^"+e.ui.autocomplete.escapeRegex(e(this).val())+"$","i"),u=!1;n.children("option").each(function(){if(e(this).text().match(s))return this.selected=u=!0,!1});if(!u||e(this).val()=="")return e(this).val(null),n.html(e('<option value="" selected="selected"></option>')),o.data("autocomplete").term="",e(t.element.parents(".controls")[0]).find(".update").addClass("disabled"),!1}}}).keyup(function(){e(this).val().length==0&&(n.html(e('<option value="" selected="selected"></option>')),n.trigger("change"))});n.attr("placeholder")&&o.attr("placeholder",n.attr("placeholder")),o.data("autocomplete")._renderItem=function(t,n){return e("<li></li>").data("item.autocomplete",n).append(e("<a></a>").html(n.label||n.id)).appendTo(t)};var u=this.button=e('<label class="add-on ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" title="Show All Items" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-triangle-1-s"></span><span class="ui-button-text">&nbsp;</span></label>').click(function(){if(o.autocomplete("widget").is(":visible")){o.autocomplete("close");return}o.autocomplete("search",""),o.focus()});s.append(o).append(u).insertAfter(n)},_getResultSet:function(t,n,r){var i=new RegExp(e.ui.autocomplete.escapeRegex(t.term),"i");return e.map(n,function(n,s){if((n.id||n.value)&&(r||i.test(n.label)))return{label:n.label?n.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.ui.autocomplete.escapeRegex(t.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):n.id,value:n.label||n.id,id:n.id||n.value}})},_getSourceFunction:function(t){var n=this,r=0;return e.isArray(t)?function(e,r){r(n._getResultSet(e,t,!1))}:typeof t=="string"?function(i,s){this.xhr&&this.xhr.abort(),this.xhr=e.ajax({url:t,data:n.options.createQuery(i.term),dataType:"json",autocompleteRequest:++r,success:function(e,t){this.autocompleteRequest===r&&s(n._getResultSet(i,e,!0))},error:function(){this.autocompleteRequest===r&&s([])}})}:t},destroy:function(){this.input.remove(),this.button.remove(),this.element.show(),e.Widget.prototype.destroy.call(this)}})})(jQuery);