/*
 * RailsAdmin filtering multiselect @VERSION
 *
 * License
 *
 * http://www.railsadmin.org
 *
 * Depends:
 *   jquery.ui.core.js
 *   jquery.ui.widget.js
 */
(function(e){e.widget("ra.filteringMultiselect",{_cache:{},options:{createQuery:function(e){return{query:e}},sortable:!1,regional:{up:"Up",down:"Down",add:"Add",chooseAll:"Choose all",chosen:"Chosen records",clearAll:"Clear all",remove:"Remove",selectChoice:"Select your choice(s) and click"},searchDelay:400,remote_source:null,xhr:!1},_create:function(){this._cache={},this._build(),this._buildCache(),this._bindEvents()},_build:function(){var t;this.wrapper=e('<div class="ra-multiselect">'),this.wrapper.insertAfter(this.element),this.header=e('<div class="ra-multiselect-header ui-helper-clearfix">'),this.filter=e('<input type="search" placeholder="'+this.options.regional.search+'" class="ra-multiselect-search"/>'),this.header.append(this.filter),this.wrapper.append(this.header),this.columns={left:e('<div class="ra-multiselect-column ra-multiselect-left">'),center:e('<div class="ra-multiselect-column ra-multiselect-center">'),right:e('<div class="ra-multiselect-column ra-multiselect-right">')};for(t in this.columns)this.columns.hasOwnProperty(t)&&this.wrapper.append(this.columns[t]);this.collection=e('<select multiple="multiple"></select>'),this.collection.addClass("ra-multiselect-collection"),this.addAll=e('<a href="#" class="ra-multiselect-item-add-all"><span class="ui-icon ui-icon-circle-triangle-e"></span>'+this.options.regional.chooseAll+"</a>"),this.columns.left.append(this.collection).append(this.addAll),this.add=e('<a href="#" class="ui-icon ui-icon-circle-triangle-e ra-multiselect-item-add">'+this.options.regional.add+"</a>"),this.remove=e('<a href="#" class="ui-icon ui-icon-circle-triangle-w ra-multiselect-item-remove">'+this.options.regional.remove+"</a>"),this.columns.center.append(this.add).append(this.remove),this.options.sortable&&(this.up=e('<a href="#" class="ui-icon ui-icon-circle-triangle-n ra-multiselect-item-up">'+this.options.regional.up+"</a>"),this.down=e('<a href="#" class="ui-icon ui-icon-circle-triangle-s ra-multiselect-item-down">'+this.options.regional.down+"</a>"),this.columns.center.append(this.up).append(this.down)),this.selection=e('<select class="ra-multiselect-selection" multiple="multiple"></select>'),this.removeAll=e('<a href="#" class="ra-multiselect-item-remove-all"><span class="ui-icon ui-icon-circle-triangle-w"></span>'+this.options.regional.clearAll+"</a>"),this.columns.right.append(this.selection).append(this.removeAll),this.element.css({display:"none"})},_bindEvents:function(){var t=this;this.addAll.click(function(n){t._select(e("option",t.collection)),n.preventDefault(),t.selection.trigger("change")}),this.add.click(function(n){t._select(e(":selected",t.collection)),n.preventDefault(),t.selection.trigger("change")}),this.removeAll.click(function(n){t._deSelect(e("option",t.selection)),n.preventDefault(),t.selection.trigger("change")}),this.remove.click(function(n){t._deSelect(e(":selected",t.selection)),n.preventDefault(),t.selection.trigger("change")});var n=null;this.options.sortable&&(this.up.click(function(n){t._move("up",e(":selected",t.selection)),n.preventDefault()}),this.down.click(function(n){t._move("down",e(":selected",t.selection)),n.preventDefault()})),this.filter.bind("keyup click",function(e){n&&clearTimeout(n),n=setTimeout(function(){t._queryFilter(t.filter.val())},t.options.searchDelay)})},_queryFilter:function(e){var t=this;t._query(e,function(e){var n,r="";for(n in e)e.hasOwnProperty(n)&&!t.selected(e[n].id)&&(r+='<option value="'+e[n].id+'">'+e[n].label+"</option>");t.collection.html(r)})},_buildCache:function(t){var n=this;this.element.find("option").each(function(t,r){r.selected?(n._cache[r.value]=r.innerHTML,e(r).clone().appendTo(n.selection).attr("selected",!1)):(n._cache[r.value]=r.innerHTML,e(r).clone().appendTo(n.collection).attr("selected",!1))})},_deSelect:function(t){var n=this;t.each(function(e,t){n.element.find("option[value="+t.value+"]").removeAttr("selected")}),e(t).appendTo(this.collection).attr("selected",!1)},_query:function(t,n){var r,i=[];if(t===""){if(!this.options.xhr)for(r in this._cache)this._cache.hasOwnProperty(r)&&i.push({id:r,label:this._cache[r]});n.apply(this,[i])}else if(this.options.xhr)e.ajax({beforeSend:function(e){e.setRequestHeader("Accept","application/json")},url:this.options.remote_source,data:this.options.createQuery(t),success:n});else{t=new RegExp(t+".*","i");for(r in this._cache)this._cache.hasOwnProperty(r)&&t.test(this._cache[r])&&i.push({id:r,label:this._cache[r]});n.apply(this,[i])}},_select:function(t){var n=this;t.each(function(t,r){var i=n.element.find("option[value="+r.value+"]");i.length?i.attr("selected","selected"):n.element.append(e('<option value="'+r.value+'" selected="selected"></option>'))}),e(t).appendTo(this.selection).attr("selected",!1)},_move:function(t,n){var r=this;t=="up"?n.each(function(t,n){var i=e(n).prev();if(i.length>0){var s=r.element.find("option[value="+n.value+"]"),o=r.element.find("option[value="+i[0].value+"]");o.before(s),i.before(e(n))}}):(e.fn.reverse=[].reverse,n.reverse().each(function(t,n){var i=e(n).next();if(i.length>0){var s=r.element.find("option[value="+n.value+"]"),o=r.element.find("option[value="+i[0].value+"]");o.after(s),i.after(e(n))}}))},selected:function(e){return this.element.find("option[value="+e+"]").attr("selected")},destroy:function(){this.wrapper.remove(),this.element.css({display:"inline"}),e.Widget.prototype.destroy.apply(this,arguments)}})})(jQuery);