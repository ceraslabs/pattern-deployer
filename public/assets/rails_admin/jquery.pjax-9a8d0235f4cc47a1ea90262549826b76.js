// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax
(function(e){function t(t,n,r){r=o(n,r);var i=t.currentTarget;if(i.tagName.toUpperCase()!=="A")throw"$.fn.pjax or $.pjax.click requires an anchor element";if(t.which>1||t.metaKey)return;if(location.protocol!==i.protocol||location.host!==i.host)return;if(i.hash&&i.href.replace(i.hash,"")===location.href.replace(location.hash,""))return;var s={url:i.href,container:e(i).attr("data-pjax"),target:i,clickedElement:e(i),fragment:null};return e.pjax(e.extend({},s,r)),t.preventDefault(),!1}function r(){return(new Date).getTime()}function i(e){return e.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function s(e){var t=document.createElement("a");return t.href=e,t}function o(t,n){return t&&n?n.container=t:e.isPlainObject(t)?n=t:n={container:t},n.container&&(n.container=u(n.container)),n}function u(t){t=e(t);if(!t.length)throw"no pjax container for "+t.selector;if(t.selector!==""&&t.context===document)return t;if(t.attr("id"))return e("#"+t.attr("id"));throw"cant get selector for pjax container!"}function a(t,n){var r=e();return t.each(function(){e(this).is(n)&&(r=r.add(this)),r=r.add(n,this)}),r}function f(t,n,r){var s={};s.url=i(n.getResponseHeader("X-PJAX-URL")||r.url);var o=e(t);if(o.length===0)return s;s.title=a(o,"title").last().text();if(r.fragment){var u=a(o,r.fragment).first();u.length&&(s.contents=u.contents(),s.title||(s.title=u.attr("title")||u.data("title")))}else/<html/i.test(t)||(s.contents=o);return s.contents&&(s.contents=s.contents.not("title"),s.contents.find("title").remove()),s.title&&(s.title=e.trim(s.title)),s}e.fn.pjax=function(e,n){return this.live("click.pjax",function(r){return t(r,e,n)})};var n=e.pjax=function(t){function d(t,n){var r=e.Event(t,{relatedTarget:i});return p.trigger(r,n),!r.isDefaultPrevented()}t=e.extend(!0,{},e.ajaxSettings,n.defaults,t),e.isFunction(t.url)&&(t.url=t.url());var i=t.target;!i&&t.clickedElement&&(i=t.clickedElement[0]);var o=s(t.url).hash,a=t.beforeSend,l=t.complete,c=t.success,h=t.error,p=t.context=u(t.container);t.data||(t.data={}),t.data._pjax=p.selector;var v;t.beforeSend=function(e,n){n.timeout>0&&(v=setTimeout(function(){d("pjax:timeout",[e,t])&&e.abort("timeout")},n.timeout),n.timeout=0),e.setRequestHeader("X-PJAX","true"),e.setRequestHeader("X-PJAX-Container",p.selector);var r;if(a){r=a.apply(this,arguments);if(r===!1)return!1}if(!d("pjax:beforeSend",[e,n]))return!1;d("pjax:start",[e,t]),d("start.pjax",[e,t])},t.complete=function(e,n){v&&clearTimeout(v),l&&l.apply(this,arguments),d("pjax:complete",[e,n,t]),d("pjax:end",[e,t]),d("end.pjax",[e,t])},t.error=function(e,n,r){var i=f("",e,t);h&&h.apply(this,arguments);var s=d("pjax:error",[e,n,r,t]);n!=="abort"&&s&&(window.location=i.url)},t.success=function(e,i,s){var u=f(e,s,t);if(!u.contents){window.location=u.url;return}n.state={id:t.id||r(),url:u.url,container:p.selector,fragment:t.fragment,timeout:t.timeout},u.title&&(document.title=u.title),p.html(u.contents),t.replace?window.history.replaceState(n.state,u.title,u.url):t.push&&window.history.pushState(n.state,u.title,u.url),(t.replace||t.push)&&window._gaq&&_gaq.push(["_trackPageview"]),o!==""&&(window.location.href=o),c&&c.apply(this,arguments),d("pjax:success",[e,i,s,t])},n.state||(n.state={id:r(),url:window.location.href,container:p.selector,fragment:t.fragment,timeout:t.timeout},window.history.replaceState(n.state,document.title));var m=n.xhr;return m&&m.readyState<4&&(m.onreadystatechange=e.noop,m.abort()),n.options=t,n.xhr=e.ajax(t),e(document).trigger("pjax",[n.xhr,t]),n.xhr};n.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html"},n.click=t;var l="state"in window.history,c=location.href;e(window).bind("popstate",function(t){var n=!l&&location.href==c;l=!0;if(n)return;var r=t.state;if(r&&r.container){var i=e(r.container);i.length?e.pjax({id:r.id,url:r.url,container:i,push:!1,fragment:r.fragment,timeout:r.timeout}):window.location=location.href}}),e.inArray("state",e.event.props)<0&&e.event.props.push("state"),e.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),e.support.pjax||(e.pjax=function(t){var n=e.isFunction(t.url)?t.url():t.url,r=t.type?t.type.toUpperCase():"GET",i=e("<form>",{method:r==="GET"?"GET":"POST",action:n,style:"display:none"});r!=="GET"&&r!=="POST"&&i.append(e("<input>",{type:"hidden",name:"_method",value:r.toLowerCase()}));var s=t.data;if(typeof s=="string")e.each(s.split("&"),function(t,n){var r=n.split("=");i.append(e("<input>",{type:"hidden",name:r[0],value:r[1]}))});else if(typeof s=="object")for(key in s)i.append(e("<input>",{type:"hidden",name:key,value:s[key]}));e(document.body).append(i),i.submit()},e.pjax.click=e.noop,e.fn.pjax=function(){return this})})(jQuery);