/*
 * RailsAdmin remote form @VERSION
 *
 * License
 *
 * http://www.railsadmin.org
 *
 * Depends:
 *   jquery.ui.core.js
 *   jquery.ui.widget.js
 *   jquery.ui.dialog.js
 */
(function(e){e.widget("ra.remoteForm",{_create:function(){var t=this,n=t.element,r=n.find("select").first().data("options")&&n.find("select").first().data("options")["edit-url"];typeof r!="undefined"&&r.length&&n.find(".ra-multiselect option").live("dblclick",function(e){t._bindModalOpening(e,r.replace("__ID__",this.value))}),n.find(".create").unbind().bind("click",function(n){t._bindModalOpening(n,e(this).data("link"))}),n.find(".update").unbind().bind("click",function(r){(value=n.find("select").val())?t._bindModalOpening(r,e(this).data("link").replace("__ID__",value)):r.preventDefault()})},_bindModalOpening:function(t,n){t.preventDefault(),widget=this;if(e("#modal").length)return!1;var r=this._getModal();setTimeout(function(){e.ajax({url:n,beforeSend:function(e){e.setRequestHeader("Accept","text/javascript")},success:function(e,t,n){r.find(".modal-body").html(e),widget._bindFormEvents()},error:function(e,t,n){r.find(".modal-body").html(e.responseText)},dataType:"text"})},200)},_bindFormEvents:function(){var t=this,n=this._getModal(),r=n.find("form"),i=n.find(":submit[name=_save]").html(),s=n.find(":submit[name=_continue]").html();n.find(".form-actions").remove(),r.attr("data-remote",!0),n.find(".modal-header-title").text(r.data("title")),n.find(".cancel-action").unbind().click(function(){return n.modal("hide"),!1}).html(s),n.find(".save-action").unbind().click(function(){return r.submit(),!1}).html(i),e(document).trigger("rails_admin.dom_ready"),r.bind("ajax:complete",function(r,i,s){if(s=="error")n.find(".modal-body").html(i.responseText),t._bindFormEvents();else{var o=e.parseJSON(i.responseText),u='<option value="'+o.id+'" selected>'+o.label+"</option>",a=t.element.find("select").filter(":hidden");if(t.element.find(".filtering-select").length){var f=t.element.find(".filtering-select").children(".ra-filtering-select-input");f.val(o.label),a.find("option[value="+o.id+"]").length||(a.html(u).val(o.id),t.element.find(".update").removeClass("disabled"))}else{var f=t.element.find(".ra-filtering-select-input"),l=t.element.find(".ra-multiselect");l.find("option[value="+o.id+"]").length?(a.find("option[value="+o.id+"]").text(o.label),l.find("option[value= "+o.id+"]").text(o.label)):(a.prepend(u),l.find("select.ra-multiselect-selection").prepend(u))}t._trigger("success"),n.modal("hide")}})},_getModal:function(){var t=this;return t.dialog||(t.dialog=e('          <div id="modal" class="modal fade">            <div class="modal-header">              <a href="#" class="close" data-dismiss="modal">&times;</a>              <h3 class="modal-header-title">...</h3>            </div>            <div class="modal-body">              ...            </div>            <div class="modal-footer">              <a href="#" class="btn cancel-action">...</a>              <a href="#" class="btn btn-primary save-action">...</a>            </div>          </div>').modal({keyboard:!0,backdrop:!0,show:!0}).on("hidden",function(){t.dialog.remove(),t.dialog=null})),this.dialog}})})(jQuery);